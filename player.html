<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Willow Player | @crictos99</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/controls.min.css"/>
<style>
  body { margin:0; background:#121212; color:white; font-family:sans-serif; text-align:center; }
  #video-container { width:100%; height:80vh; background:#000; position:relative; }
  #video { width:100%; height:100%; }
  #matchTitle { margin:10px; font-size:20px; font-weight:bold; }
  a.btn { display:inline-block; margin:15px; padding:10px 18px; border-radius:6px; background:#0088cc; color:#fff; text-decoration:none; }
  .status { margin-top:5px; font-size:14px; color:#ff5252; }
</style>
</head>
<body>

<h2 id="matchTitle">Loading...</h2>
<div id="video-container">
  <video id="video" autoplay muted poster="" data-shaka-player></video>
</div>
<a href="index.html" class="btn">⬅ Back to Matches</a>

<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.compiled.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/ui.js"></script>

<script>
(async () => {
  // --- Read URL parameters ---
  const params = new URLSearchParams(window.location.search);
  const mpdList = params.get("mpdList") ? JSON.parse(decodeURIComponent(params.get("mpdList"))) : [];
  const kid = params.get("kid");
  const key = params.get("key");
  const poster = params.get("poster");
  const title = params.get("title");

  // Set title and poster
  document.getElementById("matchTitle").textContent = decodeURIComponent(title);
  const video = document.getElementById("video");
  video.poster = poster;

  // --- Initialize Shaka Player ---
  shaka.polyfill.installAll();

  if (!shaka.Player.isBrowserSupported()) {
    alert("Browser not supported!");
    return;
  }

  const player = new shaka.Player(video);
  const ui = new shaka.ui.Overlay(player, document.getElementById('video-container'), video);

  // DRM configuration
  if (kid && key) {
    player.configure({ drm: { clearKeys: { [kid]: key } } });
  }

  player.addEventListener('error', e => console.error('Shaka Player Error', e.detail));

  // --- Load MPD links with fallback ---
  async function loadMpd(urls) {
    for (const url of urls) {
      try {
        await player.load(url);
        console.log("✅ Loaded:", url);
        break; // Stop after first successful load
      } catch (err) {
        console.warn("Failed to load:", url, err);
      }
    }
  }

  if (mpdList.length) {
    await loadMpd(mpdList);
  } else {
    alert("No MPD URLs provided!");
  }

  // --- Optional: Auto unmute after user interaction (Chrome policy) ---
  video.addEventListener('click', () => video.muted = false);
})();
</script>

</body>
</html>
